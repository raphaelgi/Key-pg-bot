from flask import Flask, request, jsonify
import time
import json

app = Flask(__name__)

# File to store valid keys
KEYS_FILE = "valid_keys.json"

# Dictionary to store valid keys and their expiration times
valid_keys = {}

# Function to verify keys
def verify_key(key):
    if key in valid_keys:
        # Check if the key has not expired
        if time.time() < valid_keys[key]:
            return True
    return False

# Load valid keys from file
def load_keys():
    global valid_keys
    try:
        with open(KEYS_FILE, "r") as file:
            valid_keys = json.load(file)
    except FileNotFoundError:
        # Create the file if it doesn't exist
        save_keys()

# Save valid keys to file
def save_keys():
    with open(KEYS_FILE, "w") as file:
        json.dump(valid_keys, file)

# Endpoint to verify keys
@app.route('/verify_key', methods=['GET'])
def verify_key_route():
    key = request.args.get('key')
    if verify_key(key):
        return jsonify({'valid': True})
    return jsonify({'valid': False, 'error': 'Invalid key.'})

# Endpoint to add keys
@app.route('/add_key', methods=['POST'])
def add_key():
    key = request.form.get('key')
    if key:
        valid_keys[key] = time.time() + 86400  # 24 hours expiration
        save_keys()  # Save keys to file
        return jsonify({'success': True})
    return jsonify({'success': False, 'error': 'No key provided'})

if __name__ == '__main__':
    load_keys()  # Load keys when the server starts
    app.run(debug=True)
